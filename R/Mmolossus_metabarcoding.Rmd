---
title: "Mmolossus Metabarcoding"
author: "Edward Hurme, Jenna, Camila"
date: "9/23/2021"
output: html_document
---
Molossus molossus
marker:fwh

# load libraries
```{r}
library(pacman)
p_load(iNEXT, lme4, car, MASS, lmerTest, effects, multcomp, data.table, 
       tidyverse, dplyr, install = TRUE)
```

# read data
```{r}
data <- fread("G#.molossus.txt", stringsAsFactors = TRUE)
table(paste(data$sex, data$Age, data$roost))
```

#wet vs dry
```{r}
data$season <- "wet"
data$season[data$month %in% 1:4] <- "dry"
data$season <- factor(data$season)
data$season %>% summary
```

# clean data
## clean up age class
```{r}
data$Age <- data$age
ages <- unique(data$age)
data$Age[data$age %in% ages[c(1,3,7)]] <- "a"
data$Age[which(data$age == "NA")] <- NA
data$Age[which(data$age == "sa")] <- "j"
data$Age <- factor(data$Age)
data$Age %>% summary
```

## clean up sex
```{r}
summary(data$sex)
data$sex[data$sex == "female"] <- "f"
```


```{r}
data %>% mutate(roost= tolower(roost)) %>% 
  drop_na(sample, roost, sex, Age) -> data 
data %>% group_by(sample, roost, sex, Age) %>% 
  summarise(n()) %>% 
  group_by(roost, sex, Age) %>% 
  summarise(n())
```

## what are identifying units?
sample and roost - samples were taken from individual bats
```{r}
data$roost %>% table
# data$sample 
```

# summarize species richness by sample
```{r}
names(data)
data %>% group_by(roost, sample, mass_of_bat, sex, Age, season) %>% 
  summarise(preyrichness = n(),
            familyrichness = length(unique(Family))) -> sample.mol

sample.mol$sex %>% table
```
# model prey richness against 
## mixed model
```{r}
glmer(preyrichness ~ sex * Age + #season + 
        (1|roost), data=sample.mol,
      family=poisson)->rich.glmm
summary(rich.glmm)

glmer(familyrichness ~ sex * Age + #season + 
        (1|roost), data=sample.mol,
      family=poisson)->frich.glmm
summary(frich.glmm)
```

## plot effect
```{r}
layout(c(1:2))
plot(effect("sex", rich.glmm, se=T), rescale.axis=FALSE, ylab="Prey richness",
     rug=FALSE, colors=palette(c("black","gray75")), cex=1.5, lwd=1)

plot(effect("Age", rich.glmm, se=T), rescale.axis=FALSE, ylab="Prey richness",
     rug=FALSE, colors=palette(c("black","gray75")), cex=1.5, lwd=1)


layout(c(1:2))
plot(effect("sex", frich.glmm, se=T), rescale.axis=FALSE, ylab="Family richness",
     rug=FALSE, colors=palette(c("black","gray75")), cex=1.5, lwd=1)

plot(effect("Age", frich.glmm, se=T), rescale.axis=FALSE, ylab="Family richness",
     rug=FALSE, colors=palette(c("black","gray75")), cex=1.5, lwd=1)
```

## Compare means per level of variable ##
```{r}
summary(glht(rich.glmm, mcp(sex="Tukey")))
```

#PerMANOVA - Prey composition####
##Load packages##
```{r}
p_load(vegan)
```

##create prey composition table##

```{r}
sp_composition <- data %>% drop_na(sex, Age) %>% 
  filter(diet.status == 'ok') %>%
  dplyr::select(sample, Species, total.diet.reads, Age, sex) %>%
  group_by(sample, Species, Age, sex) %>%
  summarise(reads = sum(total.diet.reads)) %>%
  pivot_wider(names_from = Species, values_from = reads) %>%
  mutate_if(is.numeric, replace_na, 0)

summary(sp_composition$Age)
summary(sp_composition$sex)
## Proportion of species reads
sp_composition_reads <- data.frame(Sample = sp_composition$sample, 
                                   Age = sp_composition$Age,
                                   Sex = sp_composition$sex,
                                  sp_composition[-c(1:3)]/rowSums(sp_composition[-c(1:3)]))

## Presence/absence ####
sp_composition_pa <- sp_composition %>% 
  mutate_if(is.numeric, ~1 * (. > 0)) 

## Proportion of species richness ####
sp_composition_prop <- data.frame(Sample = sp_composition_pa$sample, 
                                  Age = sp_composition$Age,
                                  Sex = sp_composition$sex, sp_composition_pa[-c(1:3)]/rowSums(sp_composition_pa[-c(1:3)]))
```

```{r}
f_composition <- data %>% drop_na(sex, Age, Family) %>% 
  filter(diet.status == 'ok') %>%
  dplyr::select(sample, Family, total.diet.reads, Age, sex) %>%
  group_by(sample, Family, Age, sex) %>%
  summarise(reads = sum(total.diet.reads)) %>%
  pivot_wider(names_from = Family, values_from = reads) %>%
  mutate_if(is.numeric, replace_na, 0)

## Proportion of species reads
f_composition_reads <- data.frame(Sample = f_composition$sample, 
                                   Age = f_composition$Age,
                                   Sex = f_composition$sex,
                                  f_composition[-c(1:3)]/rowSums(f_composition[-c(1:3)]))

## Presence/absence ####
f_composition_pa <- f_composition %>% 
  mutate_if(is.numeric, ~1 * (. > 0)) 

## Proportion of species richness ####
f_composition_prop <- data.frame(Sample = f_composition_pa$sample, 
                                  Age = f_composition$Age,
                                  Sex = f_composition$sex, f_composition_pa[-c(1:3)]/rowSums(f_composition_pa[-c(1:3)]))
```

## create species composition presence absence table

##Create distance matrix##

#Presence/absence#
```{r}
otus <- 4:83
Ym <- f_composition_pa[,otus] #select only columns with prey
dist.Y.pa <- vegdist(Ym, method="jaccard")

```

#Abundance (RRA or weighted occurrences)#
```{r}
Yma <- f_composition[,otus] #select only columns with prey
dist.Y.a <-vegdist(Yma, method="bray")
# image(as.matrix(dist.Y.pa))
```

#Build PerMANOVA model##
##Presence/absence#
```{r}
adonis(dist.Y.pa ~ sex+Age, data=f_composition_pa, 
       permutations = 999,
       method="binomial")->perm1_m
perm1_m
```


#Abundance (RRA or weighted occurrences)#
```{r}
adonis(dist.Y.a ~ Sex+Age,
       data=f_composition_prop, 
       method="bray", permutations=999)->perm2
perm2
```

##Test dispersion among groups##
### presence absence
```{r}
betadisper(dist.Y.pa, f_composition_pa$sex,#Age,
           type="centroid")->bdisp.sex
bdisp.sex

anova(bdisp.sex)

plot(bdisp.sex)

```
```{r}
betadisper(dist.Y.pa, f_composition_pa$Age,#Age,
           type="centroid")->bdisp.Age
bdisp.Age

anova(bdisp.Age)

plot(bdisp.Age)
```
### abundance
```{r}
betadisper(dist.Y.a, f_composition_prop$Sex,#Age,
           type="centroid")->bdispa.sex
bdispa.sex

anova(bdispa.sex)

plot(bdispa.sex)

```
```{r}
betadisper(dist.Y.a, f_composition_prop$Age,#Age,
           type="centroid")->bdispa.Age
bdispa.Age

anova(bdispa.Age)

plot(bdispa.Age)
```

```{r}
layout(cbind(c(1,2),c(3,4)))
plot(bdisp.sex)
plot(bdisp.Age)
plot(bdispa.sex)
plot(bdispa.Age)
```


#Assess which prey are most different##
## presence absence
```{r}
simper(Ym, f_composition_pa$sex, permutations=99)->sim1
summary(sim1)
View(sim1)
```
## abundance
```{r}
simper(Yma, f_composition_prop$Sex, permutations=99)->sim1
summary(sim1)
# View(sim1)

sim1$m_f$ava

```

##save simper results to readable file#
```{r}
sink(file = "simper_mol_family_presenceabsence_results.txt", append = TRUE)
summary(sim1)
sink()
```


####Niche-overlap####

##Load Packages##
```{r}
p_load(corrplot, spaa)
```



##Load data##
```{r}
read.delim("input.niche.FOO.txt", header=T, row.names=1)->FOO.niche
```


##Pianka niche-overlap##


```{r}
niche.overlap(nm, method = "pianka")->pianka_FOO
pianka_FOO
```


##Plot Pianka niche-overlap##
```{r}
corrplot(as.matrix(pianka_FOO), method="shade", type="lower", is.corr=TRUE,
         tl.cex=0.8, order="hclust")
```



####Bipartite Networks####

##Load Packages##
```{r}
library(bipartite)
```



##Load Data##
```{r}
data %>% names

data %>% drop_na(Family, sex, Age) %>% group_by(Family, sex, Age) %>% 
  #summarise(count = n()) #-> mfas
  summarise(count = mean(reads/total.diet.reads)) -> mfas
mfas$count %>% hist(breaks = 30)

mfas %>% 
  unite(class, c('sex', 'Age'), sep = '.') %>%
  group_by(class, Family) %>%
  summarise(counts = sum(count)) %>%
  pivot_wider(names_from = class, values_from = counts) %>% 
  mutate_if(is.numeric, replace_na, 0) -> network.matrix.m
  # mutate_if(is.numeric, ~1 * (. > 0)) 

network.matrix.m <- as.data.frame(network.matrix.m)
row.names(network.matrix.m) <- network.matrix.m$Family
nm <- network.matrix.m[,-1]
str(nm)
rowSums(nm)
```


##Plot network##
```{r}
plotweb(nm, text.rot=90)

```


##Plot interaction matrix##
```{r}
visweb(nm)

```


##Calculate species level metrics##
```{r}
specieslevel(nm)

```


##Calculate network level metrics##
```{r}
networklevel(nm)

```


##Calculate Modularity##
```{r}
computeModules(nm)
metaComputeModules(nm, N=100)->network.mod
network.mod


network.mod@originalWeb[order(network.mod@originalWeb[,1], decreasing = TRUE),1] # female adults
network.mod@originalWeb[order(network.mod@originalWeb[,2], decreasing = TRUE),2] # female juv
network.mod@originalWeb[order(network.mod@originalWeb[,3], decreasing = TRUE),3] # male adults
network.mod@originalWeb[order(network.mod@originalWeb[,4], decreasing = TRUE),4] # male juv
```



#Plot Modules#
```{r}
plotModuleWeb(network.mod)

```


#Calculate cz values#
```{r}
czvalues(network.mod)

```
























# what is temporal coverage of sampling between roosts?
```{r}
data %>% group_by(roost) %>% 
  summarise(preyitems = n()) -> roost.mol

plot(data$roost, data$month)
```

